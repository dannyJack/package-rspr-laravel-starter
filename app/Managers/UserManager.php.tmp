<?php

namespace App\Managers;

use App\Repositories\UserRepository;
use App\ResponseCodes\Manager\UserResponseCode;
use App\Responses\Manager\ManagerResponse;

class UserManager extends Manager
{
    /**
     * @var UserRepository
     */
    public UserRepository $repository;

    public function __construct(UserRepository $repository)
    {
        $this->repository = $repository;
    }

    public function all(): ManagerResponse
    {
        $rtn = $this->response();
        $rtn->data['data'] = [];
        $acquireAllResponse = $this->repository->acquireAll();
        
        if ($acquireAllResponse->success) {
            $rtn->setSuccessDefault();
            $rtn->data['data'] = $acquireAllResponse->data;
        } else {
            $rtn->setErrorDefault();
        }

        return $rtn;
    }

    public function get(int $id): ManagerResponse
    {
        $rtn = $this->response();
        $rtn->data['data'] = null;

        $acquireResponse = $this->repository->acquire($id);

        if ($acquireResponse->success && $acquireResponse->hasData) {
            $rtn->setSuccessDefault();
            $rtn->data['data'] = $acquireResponse->data;
        } else {
            $rtn->setErrorDefault();
        }

        return $rtn;
    }

    public function store(): ManagerResponse
    {
        $rtn = $this->response();
        \DB::beginTransaction();

        try {
            $username = request()->get('username');
            $email = request()->get('email');
            $attributes = [
                'username' => $username,
                'email' => $email
            ];
            $addResponse = $this->repository->NTCadd($attributes);

            if ($addResponse->success) {
                if ($addResponse->hasData) {
                    $rtn->data['data'] = $addResponse->data;
                    $rtn->setSuccessDefault();
                } else {
                    $rtn->setErrorDefault();
                }
            } else {
                $rtn->setErrorDefault();
            }

            \DB::commit();
        } catch (\Exception $e) {
            \DB::rollBack();
            \RSPRLog::error('Exception: ' . $e->getMessage());
        } catch (\Error $e) {
            \DB::rollBack();
            \RSPRLog::error($e->getMessage());
        }

        return $rtn;
    }

    public function update(int $id): ManagerResponse
    {
        $rtn = $this->response();
        \DB::beginTransaction();

        try {
            $username = request()->get('username');
            $email = request()->get('email');
            $attributes = [
                'username' => $username,
                'email' => $email
            ];
            $adjustResponse = $this->repository->NTCadjust($id, $attributes);

            if ($adjustResponse->hasData) {
                if ($adjustResponse->success) {
                        $rtn->data['data'] = $adjustResponse->data;
                        $rtn->setSuccessDefault();
                } else {
                    $rtn->setErrorDefault();
                }
            } else {
                $rtn->setError(UserResponseCode::UPDATE_ERROR_NO_USER_FOUND);
            }

            \DB::commit();
        } catch (\Exception $e) {
            \DB::rollBack();
            \RSPRLog::error('Exception: ' . $e->getMessage());
        } catch (\Error $e) {
            \DB::rollBack();
            \RSPRLog::error($e->getMessage());
        }

        return $rtn;
    }

    public function destroy(int $id): ManagerResponse
    {
        $rtn = $this->response();

        try {
            $annulResponse = $this->repository->NTCannul($id);

            if ($annulResponse->hasData) {
                if ($annulResponse->success) {
                        $rtn->data['data'] = $annulResponse->data;
                        $rtn->setSuccessDefault();
                } else {
                    $rtn->setErrorDefault();
                }
            } else {
                $rtn->setError(UserResponseCode::DESTROY_ERROR_NO_USER_FOUND);
            }
        } catch (\Exception $e) {
            \RSPRLog::error('Exception: ' . $e->getMessage());
        } catch (\Error $e) {
            \RSPRLog::error($e->getMessage());
        }

        return $rtn;
    }
}
